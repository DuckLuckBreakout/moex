# Московская биржа

## 1. Тема и целевая аудитория

### 1.1 Тема

[Московская биржа](https://www.moex.com/)
является организатором торгов акциями, облигациями, производными инструментами, валютой, инструментами денежного рынка, драгоценными металлами, зерном и сахаром.
### 1.2 MVP
- Размещение запросов на покупку/продажу акций;
- Просмотр истории изменения курса;
- Просмотр текущего курса;
- Просмотр истории сделок;
- Просмотр портфеля;
- Просмотр биржевого стакана.


### 1.3 Целевая аудитория


#### 1.3.1 Общие данные



По [данным на август 2021 года](https://www.moex.com/s719) Московская биржа имеет следующее число зарегистрированных клиентов в Системе торгов:

Тип клиента | Число|
------------- | -------------:
Физические лица	|22 591 697|	
Юридические лица	|28 709|		
Иностранные лица		|27 297|	
Иностранные физические лица 	|21 434|		
Иностранные юридические лица 		|5 863|	
Клиенты, передавшие свои средства в ДУ	|195 761|		
Всего		|22 843 464|	


По [данным на август 2021 года](https://www.moex.com/s719) Московская биржа имеет следующее число уникальных клиентов в Системе торгов:

Тип клиента | Число|
------------- | -------------:
Физические лица	|13 773 190|	
Юридические лица	|19 995|		
Иностранные лица		|20 283|	
Иностранные физические лица 	|17 471|		
Иностранные юридические лица 		|2 812|	
Клиенты, передавшие свои средства в ДУ	|122 307|		
Всего		|13 935 775|	


По [данным на август 2021 года](https://www.moex.com/s719) Московская биржа имеет следующее число активных клиентов в Системе торгов (совершивших в течение месяца хотя бы одну сделку):

Тип клиента | Число|
------------- | -------------:
Физические лица	|2 094 638|	
Юридические лица	|1 456|		
Иностранные лица		|3 097|	
Иностранные физические лица 	|2 876|		
Иностранные юридические лица 		|221|	
Клиенты, передавшие свои средства в ДУ	|40 871|		
Всего		|2 140 062|	

__98% клиентов в Системе торгов - физические лица__


#### 1.3.2 Возрастные группы

Исходя из  [исследования](https://www.tinkoff.ru/about/news/04032021-tinkoff-investments-russsian-investors-portrait-2020/) Тинькофф Инвестиций за 2020 год:

Возрастная группа | Процент |
------------- | -------------:
18-28 лет	|27%|	
28-38 лет	|43%|		
38-48 лет	|21%|		
48+ лет	|9%|		

__70% клиентов-физических лиц в Системе торгов находятся в возрасте от 18 до 38 лет__

## 2. Расчёт нагрузки

### 2.1 Продуктовые метрики


#### 2.1.1 Дневная аудитория

На [август 2021 года](https://www.moex.com/ru/spot/members-rating.aspx?rid=111) АО "Тинькофф Банк" занимает первое место по числу клиентов Московской биржи с числом клиентов равным `6 535 540` человек. Это  `6 535 540 / 22 591 697 = 29%` от числа зарегистрированных физических лиц из России.

На момент [регистрации 1млн счетов](https://www.tinkoff.ru/about/news/24092019-tinkoff-investments-opened-1-million-accounts/), ежедневно Тинькофф Инвестициями пользовались до `80 000` человек.

Предположим, что на данный момент число ежедневных пользователей "Тинькофф Инвестиции" увеличилось пропорционально увеличению общего числа зарегистрированных клиентов. Тогда на данный момент ежедневно "Тинькофф Инвестиции" используют `6.535540 * 80 000 = 522 843` пользователя. Тинькофф предоставляет интерфейс для взаимодействия с биржей `29%` всех клиентов Московской биржи, тогда можно предположить, что `522 843` это `29%` от ежедневного числа клиентов Московской биржи. Тогда ежедневное число пользователей Московской биржи: `522 843 / 0.29 = 1 802 906` человек.


#### 2.1.2 Месячная аудитория

По [данным на август 2021 года](https://www.moex.com/s719)  Московской биржей за месяц пользовалось `13 790 661` уникальных физических лица.


#### 2.1.3 Среднее количество действий пользователя по типам в день

Для примерного подсчета средней продолжительности сессии воспользуемся [данными](https://www.similarweb.com/ru/website/binance.com/#overview) о средней сессии на бирже Binance.
Средняя продолжительность сессии: `00:09:17`

Действие | Количество |
------------- | -------------:
Размещение запросов на покупку/продажу акций	| [0.64](https://www.tinkoff.ru/about/news/04032021-tinkoff-investments-russsian-investors-portrait-2020/)|	
Просмотр текущего курса	|1080|		
Просмотр истории изменения курса	|25|		
Просмотр истории сделок |25|
Просмотр портфеля |2|
Просмотр биржевого стакана |25|

### 2.2 Технические метрики

### 2.2.1 Хранение данных

#### 2.2.1.1 Курсы акций

Основные типы данных - временные ряды
По данным на апрель 2020 год число компаний, акции которых торгуются на Московской бирже равно 630.

История курса акций на Московской бирже хранится от 2004 года. Предположим что данные о курсе хранятся с интервалом в 0.5 секунды, и что все компании присутствовали на бирже с самого начала. Тогда для каждой компании необходимо хранить `60 * 60 * 2 * 9 * 365 * 17 = 402 084 000` данных о курсе на каждый период времени.

Допустим, хранится только время и курс относительно какой-то условной валюты, тогда для каждой секунды хранится:

- Время - int - 4 байта;
- Курс - double - 8 байт.

Итого 12 байт на каждую запись.

Всего на историю курса одной акции: `402 084 000 * 12 = 4 825 008 000 Байт = 4.49Гб`

Всего на историю курса всех акций: `402 084 000 * 12 * 630 = 2835 Гб = 2.77 Тб`


#### 2.2.1.2 История сделок

По данным на [первый квартал 2020 года](https://www.moex.com/n27584/?nt=106) среднедневной объем операций с акциями был равен 96,6 млрд рублей (960 тыс. сделок).

Исторические данные о ежемесячных объемах торгов представлены только в млрд рублей, так что предположим, что на один млрд рублей приходится около `960 тыс. сделок / 96.6 млрд. рублей = 9.9 тыс. сделок / млрд. рублей`.

На московской бирже [история торгов](https://www.moex.com/ru/ir/interactive-analysis.aspx#) доступна с 2009 года:

|  | 2009 |2010 |2011 |2012 |2013 |2014 |2015 |2016 |2017 |2018 |2019 |2020 |
------------- | -------------: | -------------: | -------------: | -------------: | -------------: | -------------: | -------------: | -------------: | -------------: | -------------: | -------------: | -------------: |
|млрд. рублей|15 957|	16 787|	19 678	|11 647	|8 707|	10 283|	9 398	|9 277	|9 185|	10 830| 12 443	|23 905	|	
|тыс. сделок|157 974.3 |	166 191.3|	194 812.2	|115 305.3	|86 199.3|	101 801.7|	93 040.2	|91 842.3	|90 931.5|	107 217| 123 185.7	|236 659.5	|	

Предположим, что в об одной сделке хранится следующая информация:
* время сделки;
* id покупателя;
* id продавца;
* id акции;
* число акций;
* курс продажи.


Тогда информация об одной сделке занимает около: `4 (время, int) + 4(id покупателя, int) + 4(id продавца, int) + 4(id акции, int) +  4(число акций, int) + 8(курс продажи, double) = 28 Байт`.

С 2009 по 2020 года было совершено около `1 565 160.3 тыс сделок`, следовательно общий размер записей примерно равен: `1 565 160.3 * 1000 * 28 = 43 824 488 400 Байт = 40.81 ГБ` 

#### 2.2.1.3 Портфели пользователей

Согласно [исследованию](https://www.vedomosti.ru/press_releases/2020/02/14/tinkoff-investitsii-sostavili-portret-sovremennogo-roznichnogo-investora) "Тинькофф Инвестиции":
> Около `50%` инвесторов держат в своем портфеле в среднем `5` уникальных бумаг, у `24%` клиентов в портфеле `5-10` активов, у `18%` — `10-20` позиций, у `8%` — `свыше 20` активов разных видов.

Следовательно в среднем у одного пользователя `5 * 0.5 + 7.5 * 0.24 + 15 * 0.18 + 0.08 * 50 = 11 акций`.

Для каждой акции в портфеле хранится:
* id акции, int;
* количество, int.

Тогда даные портфеля среднего пользователя занимают: `11 * (4 Байт + 4 Байт) = 88 Байт`.

Следовательно данные портфелей всех уникальных физически лиц примерно занимают: `88 Байт * 13 773 190 = 1 212 040 720 Байт = 1.12 ГБ`

#### 2.2.1.3 Данные пользователей

Найти какие конкретно данные хранит Московская биржа не получилось. 

Предположим, что о физическом лице хранится следующая информация:
* id;
* Имя;
* Фамилия;
* Серия и номер паспорта;
* id брокера, которые предоставляет данному клиенту доступ к Московской бирже.

[Каталог стандартов данных правительства Великобритании](https://webarchive.nationalarchives.gov.uk/ukgwa/20100407173424/http://www.cabinetoffice.gov.uk/govtalk/schemasstandards/e-gif/datastandards.aspx) предлагает 35 символов для каждого из полей имени и фамилии.
Длина серии и номера паспорта РФ - 10 символов.

Тогда размер данных одного пользователя равен: `4(id) + 35(Имя) + 35(Фамилия) + 10(Паспорт) + 4(id брокера) = 88 Байт`

Следовательно данные всех физических лиц на Московской бирже, у которых паспорт РФ: `88 Байт * 13 773 190 = 1 212 040 720 Байт = 1.12 ГБ`

### 2.2.2 Сетевой трафик

### 2.2.2.1 Запрос текущего курса
Основной тип трафика - запрос текущего курса.

Запрос курса на бирже Yobit занимает примерно `208` Байт.
![img](https://user-images.githubusercontent.com/49189299/134879239-f81bbaa0-aaba-417f-9c92-0d89207ef834.png)


Тогда один пользователь в день получает ответов с текущим курсом на
`208 * 1080 = 224 640 Байт`

В день биржей пользуется около `1 802 906` человек, следовательно суммарно на запрос курса отправляется около `405 004 803 840 Байт = 377.19 ГБ`

Торговая сессия длится `9 часов = 32 400 сек`, следовательно в секунду трафик запросов на текущий курс: `377.19 Гб / 32 400 сек = 0.011 ГБ/сек = 11.9 МБ/сек`

### 2.2.2.2 Размещение запроса на продажу

Запрос на продажу на бирже Yobit занимает примерно `171` Байт.
![image](https://user-images.githubusercontent.com/49189299/137755546-772e6069-4817-497b-9c87-fb364aa7d920.png)

Тогда один пользователь в день получает ответов на запросы на продажу на
`171 * 0.64 = 109.44 Байт`

В день биржей пользуется около `1 802 906` человек, следовательно суммарно на запросы на продажу отправляется около `197 310 032 Байт = 0.18 ГБ`

Торговая сессия длится `9 часов = 32 400 сек`, следовательно в секунду трафик на запросы на продажу: `0.18 ГБ / 32 400 сек = 0.000006 ГБ/сек = 0.006 МБ/сек`

### 2.2.2.3 Запрос на получение истории курса

Запрос на продажу на бирже Yobit занимает примерно `4.1` кБ.
![Снимок экрана 2021-10-18 в 18 54 09](https://user-images.githubusercontent.com/49189299/137766260-5bb413dd-9f1d-46d0-82c0-cf27d1932a8e.png)

Тогда один пользователь в день получает ответов на запросы на получение истории курса:
`4.1 * 25 = 102.5 кБ`

В день биржей пользуется около `1 802 906` человек, следовательно суммарно на запросы получение истории курса отправляется около `184 797 865 кБ = 176.24 ГБ`

Торговая сессия длится `9 часов = 32 400 сек`, следовательно в секунду трафик на получение истории курса: `176.24 ГБ / 32 400 сек = 0.0054 ГБ/сек = 5.57 МБ/сек`

### 2.2.2.4 Запрос на получение истории сделок

Запрос на получение истории сделок на бирже Yobit занимает примерно `816` Байт.
![Снимок экрана 2021-10-18 в 19 06 11](https://user-images.githubusercontent.com/49189299/137768156-28113717-70f9-4995-a0bd-65793d319a8e.png)

Тогда один пользователь в день получает ответов на запросы на получение истории сделок:
`816 * 25 = 20 400 Байт`

В день биржей пользуется около `1 802 906` человек, следовательно суммарно на запросы получение истории сделок отправляется около `36 779 282 400 Байт = 34.25 ГБ`

Торговая сессия длится `9 часов = 32 400 сек`, следовательно в секунду трафик на получение истории сделок: `34.25 ГБ / 32 400 сек = 0.001 ГБ/сек = 1.08 МБ/сек`

### 2.2.2.5 Запрос на получение биржевого стакана

Запрос на получение биржевого стакана на бирже Yobit занимает примерно `5.1` кБ.
![Снимок экрана 2021-10-18 в 19 34 16](https://user-images.githubusercontent.com/49189299/137772140-1b4a9298-d2be-4545-a031-5a10d92805bb.png)

Тогда один пользователь в день получает ответов на запросы на получение истории сделок:
`5.1 * 25 = 127.5 кБ`

В день биржей пользуется около `1 802 906` человек, следовательно суммарно на запросы получение истории сделок отправляется около `229 870 515 кБ = 219.22 ГБ`

Торговая сессия длится `9 часов = 32 400 сек`, следовательно в секунду трафик на получение истории сделок: `219.22 ГБ / 32 400 сек = 0.007 ГБ/сек = 7.168 МБ/сек`



### 2.2.3 RPS в разбивке по типам запросов (запросов в секунду) 
Один пользователь в день совершает в среднем `1 157.64` действий.

Следовательно в день суммарно `1 157.64 * 1 802 906 = 2 087 116 101.84` действий.

Торговая сессия длится `32 400` секунд, следовательно `RPS = 2 087 116 101.84 / 32 400 = 64417.16`

Действие | RPS | Тип |
------------- | -------------:| -------------:
Размещение запросов на покупку/продажу акций	| 35.61 |	запись
Просмотр текущего курса	|60 253 |	чтение
Просмотр истории изменения курса	|1 288.34| чтение		
Просмотр истории сделок |1 288.34| чтение
Просмотр портфеля |103.07| чтение
Просмотр биржевого стакана |1 288.34| чтение

